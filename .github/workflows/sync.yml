name: Sync Fork

on:
  schedule:
    # Runs automatically every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    # Allows you to run this manually from the Actions tab

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Check out your repository
      - name: Checkout Your Repository
        uses: actions/checkout@v4
        with:
          # We need to use the PAT here for subsequent steps that push changes
          token: ${{ secrets.PAT }}
          # Fetch all history so we can do a proper merge
          fetch-depth: 0

      # Step 2: Run the fork-sync action to create a pull request
      - name: Create Pull Request from Upstream
        id: sync
        uses: wei/pull@v1
        with:
          # This action requires the PAT
          token: ${{ secrets.PAT }}
          # The repository to sync FROM
          upstream_repo: 'pflyly/eden-nightly'
          upstream_branch: 'main'
          # The branch in THIS repository to sync TO
          downstream_branch: 'main'

      # Step 3: Automatically merge the pull request if one was created
      - name: Auto Merge
        if: steps.sync.outputs.pull_request_number != ''
        run: |
          gh pr merge ${{ steps.sync.outputs.pull_request_number }} --squash --delete-branch
        env:
          GH_TOKEN: ${{ secrets.PAT }}

      # Step 4: Manually restore your protected files after the merge
      # This ensures your custom files are always the correct version.
      - name: Restore Protected Files
        if: steps.sync.outputs.pull_request_number != ''
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git checkout main -- README.md
          git checkout main -- .github/patches/
          git checkout main -- .github/workflows/
          git commit -m "Restore protected files after upstream sync" || echo "No changes to commit"
          git push
